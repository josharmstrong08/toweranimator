<!doctype html>
<meta charset="utf-8" />  
<html>
<head>
<title>Tower Animator</title>
</head>
<link rel="stylesheet" href="css/smoothness/jquery-ui-1.10.1.custom.css" />
<style>
body {
  font: 75% "Trebuchet MS", sans-serif;
}
.paneltitle {
  font-size: 36px;
  font-weight: bold;
}
#animationlist {
  list-style-type: none;
  margin-top: 10px;
  padding-left: 0px;
  height: 250px;
  overflow: auto;
}
#animationlist li {
  padding: 4px;
  height: 18px;
}
#animationlist li .handle {
  float: left;
  padding: 3px;
  cursor: pointer;
}
#playercontrols {
  width: 300px;
  height: 60px;
  background: #333;
  padding-top: 20px;
  padding-left: 20px;
  color: #fff;
}
#playbutton {
  cursor: pointer;
  width: 30px;
  height: 30px;
  float: left;
}
#playbutton span.ui-icon {
  margin: auto;
  margin-top: 7px;
}
#currentanimationcontainer {
  float: left;
  padding-left: 10px;
  width: 200px;
}
#currentanimationtitle {
  height: 15px;
  margin-top: -2px;
  padding-bottom: 2px;
}
#currentanimationpos {
  height: 15px;
}
.config-label {
  text-align: right;
  width: 140px;
}
.config-value {
  padding-left: 20px;
}
#lagslider {
  width: 200px;
  float: left;
}
#pingdiv {
  float: left;
  margin-top: 9px;
}
#pingbutton {
  float: left;
}
#refreshbutton {
  float: right;
  width: 20px;
  height: 20px;
  cursor: pointer; 
}
.ui-selectable-helper { display:none }
</style>
<script src="js/jquery-1.9.1.js"></script>
<script src="js/jquery-ui-1.10.1.custom.js"></script>
<script>
$(function() {
  var websocket = new WebSocket("ws://" + window.location.host + "/");
  var animations = [];
  var isAudioDoneLoading = false;
  var isVideoDoneLoading = false;
  var readyToPlay = false;
  var playing = false;
  var currentAnimation = null;
  var currentIndex = false;

  var animationDoneLoading = function() {
    $("#currentanimationtitle").text(currentAnimation.title);

    if (isAudioDoneLoading == true && isVideoDoneLoading == true) {
      readyToPlay = true;
      $("#playbutton").removeClass('ui-state-disabled');
      $("#currentanimationpos").progressbar('option', 'max', $("#audioplayer")[0].duration);
      $("#currentanimationpos").progressbar('value', 0);
    } else {
      $("#currentanimationpos").progressbar('value', false);
      $("#playbutton span").removeClass('ui-icon-stop');
      $("#playbutton span").addClass('ui-icon-play');
      $("#playbutton").addClass("ui-state-disabled");
      //playing = false;
    }
  }

  /** 
   * Initialize the audio and video loading
   */
  var loadAnimation = function(index) {
    //playing = false;
    currentAnimation = animations[index];
    isAudioDoneLoading = false;
    isVideoDoneLoading = false;
    websocket.send(JSON.stringify({type:"load", index: animations.indexOf(currentAnimation)}));
    $('#audioplayer').attr('src', currentAnimation.music);
    $('#audioplayer')[0].load();
  };
  
  // Websocket ----------------------------------------------------------
  websocket.onopen = function(ev) {
    $("#serverstatus").text("Connected");
  };
  websocket.onclose = function(ev) {
    $("#serverstatus").text("Disconnected");
  };
  websocket.onmessage = function(ev) {
    var msg = JSON.parse(ev.data);
    switch (msg.type) {
      case 'pong':
        $("#pingdiv").text("Ping... Pong");
        window.setTimeout(function() { $("#pingdiv").text(''); }, 2000);
        break;
      case 'animationlist':
        $("#animationlist").empty();
        animations = msg.animations;
        var length = msg.animations.length;
        for (var i = 0; i < length; i++) {
          msg.animations.id = i;
          $("#animationlist").append('<li id="animation' + i +  '" class="ui-state-default ui-corner-all"><div class="handle"><span class="ui-icon ui-icon-carat-2-n-s"></span></div>' + msg.animations[i].title + '</li>');
        }
        break;
      case 'error':
        alert("Server error: " + msg.message);
        break;
      case 'doneloading':
        isVideoDoneLoading = true;
        animationDoneLoading(); 
        break;
      default:
        alert('Unrecognized server message: ' + ev.data);
        break;
    }
  };
  websocket.onerror = function(ev) {
    $("#serverstatus").text("Error: " + ev.data);
    alert("Websocket error: " + ev.data);
  };

  // Animation list -----------------------------------------------
  $("#animationlist")
    .sortable({ handle: ".handle"})
    .selectable({ 
      tolerance: 'fit',
      selected: function(e,u) {
        $(u.selected).addClass('ui-state-active'); 
        currentIndex = parseInt(u.selected.id.substring(9, u.selected.id.length), 10)
        if (playing == false) {
          loadAnimation(currentIndex);
        }
      },
      unselected: function(e,u) { $(u.unselected).removeClass('ui-state-active'); }
    })
    //.find("li")
    //  .addClass("ui-corner-all")
    //  .prepend("<div class='handle'><span class='ui-icon ui-icon-carat-2-n-s'></span></div>");
  $("#refreshbutton")
    .hover(
      function() { $(this).addClass("ui-state-hover");},
      function() {$(this).removeClass("ui-state-hover");}
    )
    .mousedown(function() { $(this).addClass("ui-state-active"); })
    .mouseup(function() { $(this).removeClass("ui-state-active"); })
    .click(function() {
      websocket.send(JSON.stringify({type:"getanimations"})); 
      $("#animationlist").empty();
    });

  // Audio player---------------------------------------------------
  // Send the play signal to the server when the audio starts playing
  $("#audioplayer").bind('play', function() { 
    console.log("play " + animations.indexOf(currentAnimation));
    websocket.send(JSON.stringify({type:"play", index: animations.indexOf(currentAnimation)}));
  });
  // Catch when the audio is done loading
  $("#audioplayer").bind('canplaythrough', function() { 
    isAudioDoneLoading = true;
    console.log("Audio can play through");
    animationDoneLoading();
  });
  $("#audioplayer").bind('timeupdate', function() {
    $("#currentanimationpos").progressbar('value', $("#audioplayer")[0].currentTime);
  });
  $("#playbutton")
    .hover(
      function() {
        if (readyToPlay) {
          $(this).addClass("ui-state-hover");
        }
      },
      function() { $(this).removeClass("ui-state-hover"); }
    )
    .mousedown(function() {
      if (readyToPlay) {
        $(this).addClass("ui-state-active");
      }
    })
    .mouseup(function() {
      //$(this).removeClass("ui-state-active");
    })
    .click(function() {
      if (playing == false) {
        if (readyToPlay) {
          $("#audioplayer")[0].play();
          $("#playbutton span").removeClass('ui-icon-play');
          $("#playbutton span").addClass('ui-icon-stop');
          playing = true;
        }
      } else {
        $("#audioplayer")[0].pause();
        $("#audioplayer")[0].currentTime = 0;
        $("#playbutton span").removeClass('ui-icon-stop');
        $("#playbutton span").addClass('ui-icon-play');
        playing = false;

        websocket.send(JSON.stringify({type:"stop"}));

        // Load the currently selected animation
        if (animations[currentIndex] != currentAnimation) {
          loadAnimation(currentIndex);
        }
      }
    })
  $("#currentanimationpos").progressbar({value: 0, max: 1});

  // Configuration tab -------------------------------------------
  $("#tabs").tabs();
  $("#lagslider").slider({value: [50]});
  $("#pingbutton").button();
  $("#pingbutton").click(function() {
    websocket.send(JSON.stringify({type:"ping"}));
    $("#pingdiv").text("Ping...");
  });
});
</script>
</head>
<body>
<div id="tabs">
  <ul>
    <li><a href="#tabs-1">Animations</a></li>
    <li><a href="#tabs-2">Configuration</a></li>
  </ul>
  <div id="tabs-1">
    <span class="paneltitle">Animations</span>
    <div id="refreshbutton" class="ui-corner-all ui-state-default"><span class="ui-icon ui-icon-refresh"></span></div>
    <ul id="animationlist" class="ui-widget"></ul> 
    <div id="playercontrols" class="ui-corner-all ui-state-default">
      <audio id="audioplayer" preload="auto"></audio>
      <div id="playbutton" class="ui-corner-all ui-state-default ui-state-disabled"><span class="ui-icon ui-icon-play"></span></div>
      <div id="currentanimationcontainer">
        <div id="currentanimationtitle"></div>
        <div id="currentanimationpos"></div>
      </div>
    </div>
  </div>
  <div id="tabs-2">
    <span class="paneltitle">Configuration</span>
    <table id="configtable">
    <tr>
      <td class="config-label">Server Status:</td>
      <td class="config-value"><div id="serverstatus"></div>Not connected</td>
    </tr><tr>
      <td class="config-label">Lag:</td>
      <td class="config-value"><div id="lagslider"></div></td>
    </tr><tr>
      <td class="config-label">Ping Server:</td>
      <td class="config-value">
        <button id="pingbutton">Ping</button>
        <div id="pingdiv"></div>
      </td>
    </tr>
    </table>
  </div>
</div>
</body>
</html>

